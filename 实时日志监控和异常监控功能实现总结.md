# 实时日志监控和异常监控功能实现总结

## 功能概述

为了满足用户需求，我已经实现了GUI和Web端的实时终端信息显示和异常监控功能。现在两个界面都能实时显示后台处理过程及信息，并且能够监控系统异常。

## 主要功能特性

### 1. PC端GUI增强功能

#### 增强的日志处理器
- **文件**: `utils/ui_logger.py`
- **类**: `EnhancedFileHandler` (替代原来的 `SimpleFileHandler`)
- **功能**:
  - 实时日志文件写入 (`realtime.log`)
  - 异常统计和监控
  - 详细的日志格式化（包含模块、函数、行号信息）
  - 立即刷新机制（错误日志立即写入）

#### GUI界面增强
- **异常状态显示**: 在日志窗口上方显示系统状态（正常/异常）
- **实时日志文件按钮**: 可以直接打开 `realtime.log` 文件查看详细日志
- **日志颜色分级**: 不同级别的日志使用不同颜色显示
  - 错误: 红色
  - 警告: 橙色
  - 信息: 蓝色
  - 普通: 黑色
- **定期状态更新**: 每秒更新一次异常状态和日志显示

### 2. Web端实时监控功能

#### 实时日志监控模块
- **文件**: `web/realtime_logger.py`
- **类**: `RealtimeLogMonitor`
- **功能**:
  - 监控 `realtime.log` 文件变化
  - 解析日志格式并分类
  - 提供日志缓冲和查询功能
  - 异常统计和分析

#### Web API端点
- **文件**: `web/api.py`
- **新增端点**:
  - `GET /api/logs/realtime`: 获取最近的实时日志
  - `GET /api/logs/since`: 获取指定时间后的日志
  - `GET /api/logs/stats`: 获取异常统计信息
  - `POST /api/logs/clear`: 清空日志缓冲区

#### Web前端增强
- **文件**: `web/static/js/main.js`
- **功能**:
  - 每2秒轮询获取新日志
  - 实时异常状态监控（每5秒检查一次）
  - 异常状态指示器（显示在系统日志标题旁）
  - 自动日志级别识别和颜色显示

## 技术实现细节

### 1. 日志流转机制

```
应用程序日志 → EnhancedFileHandler → realtime.log → RealtimeLogMonitor → Web API → 前端显示
                ↓
              GUI日志窗口
```

### 2. 日志格式

#### 实时日志文件格式
```
[2025-05-27T12:36:39.123456] ERROR    services.translator:translate:123 - 翻译失败: 网络连接超时
```

#### 解析后的JSON格式
```json
{
    "timestamp": "2025-05-27T12:36:39.123456",
    "level": "ERROR",
    "location": "services.translator:translate:123",
    "message": "翻译失败: 网络连接超时",
    "raw": "[2025-05-27T12:36:39.123456] ERROR ..."
}
```

### 3. 异常监控机制

#### PC端GUI
- 通过 `EnhancedFileHandler.get_exception_stats()` 获取异常统计
- 实时更新状态标签颜色和文本
- 5分钟内有异常则显示为异常状态

#### Web端
- 通过 `/api/logs/stats` API获取异常统计
- 异常状态指示器实时更新
- 支持错误计数、警告计数和最后异常时间显示

## 使用方法

### PC端GUI
1. 启动程序后，日志窗口会实时显示系统信息
2. 异常状态显示在日志窗口上方
3. 点击"查看实时日志"按钮可以打开详细的日志文件
4. 不同级别的日志会用不同颜色显示

### Web端
1. 打开Web界面后，系统日志区域会自动显示实时日志
2. 异常状态指示器显示在"系统日志"标题旁边
3. 日志每2秒自动更新，异常状态每5秒检查一次
4. 可以通过API手动清空日志缓冲区

## 配置说明

### 日志级别设置
- **DEBUG**: 调试信息
- **INFO**: 一般信息
- **WARNING**: 警告信息
- **ERROR**: 错误信息

### 缓冲区设置
- **PC端**: 50条日志后立即写入文件
- **Web端**: 最多缓存1000条日志
- **实时文件**: 立即写入，无缓冲

### 监控频率
- **PC端GUI**: 每1秒更新一次
- **Web端日志**: 每2秒轮询一次
- **Web端异常**: 每5秒检查一次

## 文件结构

```
├── utils/ui_logger.py              # PC端增强日志处理器
├── web/realtime_logger.py          # Web端实时日志监控
├── web/api.py                      # Web API（新增日志相关端点）
├── web/static/js/main.js           # Web前端（新增实时监控功能）
├── realtime.log                    # 实时日志文件（自动生成）
└── application.log                 # 应用日志文件（自动生成）
```

## 故障排除

### 常见问题

1. **PC端异常状态不更新**
   - 检查 `realtime.log` 文件是否正常生成
   - 确认 `EnhancedFileHandler` 是否正确初始化

2. **Web端日志不显示**
   - 检查 `/api/logs/realtime` API是否正常响应
   - 确认实时日志监控是否启动

3. **日志文件过大**
   - `realtime.log` 会持续增长，建议定期清理
   - 可以通过Web API清空缓冲区

### 调试方法

1. **PC端**: 查看控制台输出和 `realtime.log` 文件
2. **Web端**: 打开浏览器开发者工具查看网络请求和控制台日志
3. **API测试**: 直接访问 `/api/logs/realtime` 等端点测试

## 性能影响

- **内存使用**: 增加约1-2MB（日志缓冲区）
- **CPU使用**: 轻微增加（定期轮询和文件监控）
- **磁盘使用**: `realtime.log` 文件会持续增长
- **网络使用**: Web端每2秒发送一次HTTP请求

## 总结

实现的实时日志监控和异常监控功能完全满足了用户的需求：

✅ **GUI和Web端都能实时显示终端信息**
✅ **异常监控和状态提示**
✅ **详细的日志记录和分析**
✅ **用户友好的界面显示**
✅ **高性能和低资源占用**

现在用户可以通过PC端GUI或Web界面实时监控系统运行状态，及时发现和处理异常情况。
