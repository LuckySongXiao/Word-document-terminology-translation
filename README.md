# 多格式文档-AI双语翻译助手

一款基于AI技术的文档翻译工具，支持Word、PDF和Excel文件翻译，集成多种翻译API接口，包括智谱AI、Ollama、硅基流动API和内网OPENAI平台。

## 最新更新

### 2025-01-26 - Web界面翻译器管理优化
- **新增内网OPENAI平台支持**: Web界面现在包含内网OPENAI翻译器选项
- **修复翻译器状态显示**: 解决了所有平台模型状态显示为不可用的问题
- **优化状态检查逻辑**:
  - 智谱AI: 进行真实连接测试
  - Ollama: 检查模型列表可用性
  - 硅基流动: 进行API连接测试（而非仅检查API key存在）
  - 内网OPENAI: 按需检测机制，显示为"按需检测"状态
- **改进前端状态显示**:
  - 内网翻译器显示为橙色"按需检测"状态
  - 可用服务显示为绿色"可用"状态
  - 不可用服务显示为红色"不可用"状态
- **完善翻译器选择**: 用户现在可以选择所有四种翻译器类型

## 功能特点

- 支持Word文档、PDF文件和Excel文件翻译，保留原文档格式
- 支持自定义术语库，确保专业术语翻译准确
- 支持多种AI翻译引擎
- 翻译结果以双语形式展示
- 导出翻译对照表为Excel
- **术语预处理功能**：先检测文本中的术语，再进行翻译
- **数学公式保留功能**：自动识别并保留LaTeX格式的数学公式，不对其进行翻译
- **PDF导出功能**：可选择将翻译结果同时导出为PDF格式（Word）
- **思维链过滤功能**：自动过滤AI模型生成的思维链内容，只保留纯净的翻译结果
- **实时日志同步**：Web界面的系统日志与终端控制台实时同步，便于开发调试和问题排查
- **PDF处理优化**：改进了PDF文件在外语→中文翻译时的效果，使用反向术语库缓存机制，翻译质量与Word文件一致
- **图片处理简化**：大幅简化PDF图片处理流程，移除复杂的格式转换逻辑，图片显示成功率从60-70%提升到90%+

## 使用方法

1. 启动程序
2. 选择要翻译的文档（支持Word文档、PDF文件和Excel文件 ）
3. 选择翻译方向（中文→外语 或 外语→中文）
4. 选择目标语言
5. 根据需要选择是否使用术语库和术语预处理功能
6. 如需导出PDF，勾选"导出PDF文件"选项（Word文档需要安装Microsoft Word，Excel文档需要安装Microsoft Excel）
7. 点击"开始翻译"
8. 翻译完成后，程序会生成带有原文和译文的文档，如选择了PDF导出，还会生成对应的PDF文件

## 术语预处理功能详细说明

### 功能原理

术语预处理功能是一个翻译流程优化方案，通过在翻译前识别和处理专业术语，确保翻译结果的准确性和一致性。其工作原理如下：

1. **术语检测与提取**：
   - 程序首先遍历目标文本（段落、表格、幻灯片等）
   - 根据翻译方向（中文→外语或外语→中文）采用不同的检测策略
   - 对于中文→外语翻译，使用`extract_terms`方法提取中文术语
   - 对于外语→中文翻译，使用`extract_foreign_terms_by_chinese_values`方法提取外语术语
   - 所有检测到的术语会形成一个"待使用术语词典"，仅包含文本中实际存在的术语

2. **术语替换**：
   - 将文本中的原文术语替换为特定格式的占位符（如"[术语0]"、"[术语1]"等）
   - 对于中文→外语翻译，使用`replace_terms_with_placeholders`方法
   - 对于外语→中文翻译，使用`replace_foreign_terms_with_placeholders`方法
   - 系统会维护一个术语映射表，记录每个占位符对应的原文术语和目标语言术语

3. **翻译处理**：
   - 将替换后的文本（含占位符）送入AI进行翻译
   - 此步骤不使用术语库参数，因为术语已被预处理为占位符

4. **术语恢复**：
   - 翻译完成后，使用`restore_placeholders_with_foreign_terms`或`restore_placeholders_with_chinese_terms`方法
   - 将翻译结果中的占位符替换回目标语言的对应术语
   - 确保所有术语在最终翻译中保持一致性

5. **术语使用分析**：
   - 系统会自动导出一个Excel文件，记录文档中使用的所有术语
   - 该文件包含原文术语和对应的目标语言术语，方便用户分析和审核

### 技术实现细节

1. **术语匹配策略**：
   - 中文术语匹配使用正则表达式`(?<![a-zA-Z0-9])术语(?![a-zA-Z0-9])`，确保匹配完整术语
   - 外语术语匹配使用单词边界`\b术语\b`，避免部分匹配问题
   - 术语按长度降序排序处理，确保优先匹配最长的术语

2. **占位符设计**：
   - 使用中文格式的占位符`[术语{index}]`，更容易被翻译模型保留
   - 每个占位符包含唯一索引，确保正确恢复

3. **文档类型适配**：
   - Word文档：分别处理段落和表格中的术语
   - PDF文件：按页面处理，提取并处理每页文本中的术语
   - Excel文件：处理表格和单元格中的术语

### 优势与效果

1. **精准术语翻译**：
   - 确保专业术语的翻译准确性和一致性
   - 避免同一术语在文档不同位置有不同翻译的问题

2. **减少AI误译**：
   - 通过预先替换术语，避免AI对专业术语的误解和错误翻译
   - 特别适用于专业领域文档，如技术手册、学术论文等

3. **提高翻译质量**：
   - 让AI专注于处理普通文本的翻译，提高整体翻译质量
   - 减少术语翻译错误导致的上下文理解偏差

4. **术语使用分析**：
   - 通过导出的术语使用表，可以分析文档中的术语使用情况
   - 帮助用户优化术语库，添加常用但缺失的术语

### 使用建议

1. **适用场景**：
   - 包含大量专业术语的技术文档
   - 需要保持术语一致性的长篇文档
   - 多人协作翻译的大型项目

2. **术语库准备**：
   - 建议提前准备完善的术语库，包含领域内常用术语
   - 可通过CSV文件导入术语库，格式为"中文术语,外语术语"

3. **翻译效率**：
   - 术语预处理可能会略微增加翻译时间，但显著提高翻译质量
   - 对于术语密集型文档，强烈建议启用此功能

## 翻译引擎配置

- 智谱AI：需要在API_config/zhipu_api.json中配置API Key
- Ollama：需要在API_config/ollama_api.json中配置API地址
- 硅基流动：需要在API_config/siliconflow_api.json中配置API Key
- 内网OPENAI：需要在config.json中的intranet_translator部分配置API地址和模型

### 内网OPENAI平台配置

内网OPENAI平台支持连接到内网部署的OpenAI兼容API服务，配置示例：

```json
{
  "intranet_translator": {
    "type": "intranet",
    "api_url": "http://192.168.100.71:8000/v1/chat/completions",
    "model": "deepseek-r1-70b",
    "timeout": 60.0
  }
}
```

特点：
- **按需检测**: 启动时不进行连接检测，仅在用户选择时检测状态
- **兼容性**: 支持所有OpenAI Chat Completions API兼容的服务
- **灵活配置**: 支持自定义API地址、模型名称和超时时间

## 数学公式处理功能

### 功能原理

数学公式处理功能可以自动识别文档中的LaTeX格式数学公式，并在翻译过程中保留这些公式，不对其进行翻译。这确保了数学公式在翻译后仍然保持正确的格式和含义。

支持的公式格式包括：
1. 行内公式：$...$
2. 行间公式：$$...$$
3. equation环境：\begin{equation}...\end{equation}
4. align环境：\begin{align}...\end{align}
5. eqnarray环境：\begin{eqnarray}...\end{eqnarray}

### 工作流程

1. **公式识别**：程序使用正则表达式识别文本中的LaTeX格式数学公式。
2. **公式提取**：将识别到的公式提取出来，并用占位符替换。
3. **文本翻译**：只翻译不包含公式的文本部分。
4. **公式恢复**：翻译完成后，将占位符替换回原始公式。
5. **结果输出**：最终输出的文档中，数学公式保持原样，其余文本被翻译。

## PDF导出功能

PDF导出功能允许用户将翻译结果同时导出为PDF格式，方便分享和打印。

### 使用要求

- 需要安装Microsoft Word（用于将DOCX转换为PDF）
- 在翻译前勾选"导出PDF文件"选项

### 工作流程

1. 完成Word文档的翻译
2. 使用docx2pdf库调用Microsoft Word将DOCX文件转换为PDF
3. 在相同位置生成同名的PDF文件

## PDF文件处理功能

PDF文件处理功能允许用户直接翻译PDF文件，无需先将其转换为Word文档。

### 功能特点

1. **直接读取PDF**：程序可以直接读取PDF文件中的文本内容。
2. **按页处理**：PDF文件会按页进行处理，每页的内容会被单独提取和翻译。
3. **保留段落结构**：程序会尽可能保留PDF中的段落结构。
4. **数学公式支持**：与Word文档一样，PDF中的LaTeX格式数学公式也会被识别和保留。
5. **术语处理**：支持对PDF文件中的专业术语进行预处理和翻译。
6. **智能文本提取**：优化的文本提取算法，能够处理各种PDF格式，避免逐字符提取问题。
7. **批量处理**：支持批量处理段落，减少API调用次数，提高翻译效率。
8. **反向术语库缓存**：针对外语→中文翻译优化，使用预先创建的反向术语库缓存，显著提升术语匹配效率和翻译质量。
9. **完整日志同步**：PDF处理过程中的所有日志都会实时同步到终端控制台和Web界面，便于监控翻译进度。
10. **简化图片处理**：参照Word文档处理器的简洁方式，大幅简化图片处理流程，移除复杂的格式转换逻辑，图片显示成功率显著提升。
11. **统一占位符样式**：使用统一的蓝色粗体居中样式显示图片占位符，确保视觉效果与Word文档处理器一致。

### 工作流程

1. **文件选择**：用户选择PDF文件作为输入。
2. **文本提取**：程序使用pdfplumber库从PDF中提取文本内容，并进行智能优化。
   - 检测并修复逐字符提取问题
   - 尝试多种提取策略（文本、表格、单词提取）
   - 优化中文字符间的空格问题
3. **段落优化**：
   - 合并过短的文本片段形成有意义的段落
   - 设置最小段落长度阈值，避免处理过短的文本
   - 批量处理段落，减少API调用次数
4. **翻译处理**：将处理后的文本送入AI进行翻译。
5. **结果输出**：将翻译结果保存为Word文档，每页的原文和译文会被清晰地标记。
6. **可选PDF导出**：如果用户选择了PDF导出选项，还会生成对应的PDF文件。

### 注意事项

- PDF文件的复杂格式（如多列布局、复杂表格等）可能无法完全保留。
- 某些加密或扫描的PDF文件可能无法正确提取文本。
- 对于包含大量图片或特殊格式的PDF文件，建议先转换为Word文档再进行翻译。
- 程序会自动检测并尝试修复PDF文本提取问题，但对于某些特殊格式的PDF可能仍需手动调整。

## Excel文件处理功能

Excel文件处理功能允许用户直接翻译Excel文件，支持.xlsx格式。

### 功能特点

1. **直接读取PPT**：程序可以直接读取PPT文件中的文本内容。
2. **处理文本框和表格**：支持翻译PPT中的文本框和表格内容。
3. **保留PPT格式**：翻译后的PPT保留原有的格式、布局和样式。
4. **数学公式支持**：与Word文档一样，PPT中的LaTeX格式数学公式也会被识别和保留。
5. **术语处理**：支持对PPT文件中的专业术语进行预处理和翻译。
6. **双语展示**：翻译结果以原文+译文的形式展示，便于对照。
7. **经输出翻译结果**: 翻译结果会以纯翻译结果保存为新的文件，原文件保持不变。
8. **PDF导出**：支持将翻译后的PPT导出为PDF格式（需要安装Microsoft PowerPoint）。

### 工作流程

1. **文件选择**：用户选择PPT文件作为输入。
2. **内容提取**：程序使用python-pptx库从PPT中提取文本内容。
3. **翻译处理**：
   - 提取每个幻灯片中的文本框和表格内容
   - 对提取的文本进行翻译，同时保留数学公式
   - 将翻译后的文本添加到原文本后面
4. **结果输出**：将翻译结果保存为新的PPT文件。
5. **可选PDF导出**：如果用户选择了PDF导出选项，还会生成对应的PDF文件。

### 注意事项

- 复杂的PPT布局和特殊效果可能会影响翻译效果。
- 翻译大型PPT文件可能需要较长时间，请耐心等待。
- 对于包含大量图片或特殊格式的PPT文件，翻译效果可能不如纯文本PPT。

## 思维链过滤功能

### 功能原理

思维链过滤功能可以自动识别并过滤掉AI模型在生成翻译结果时可能包含的思维链内容，确保最终输出的翻译结果是纯净的。

某些AI模型（如支持思维链的模型）在生成翻译时，可能会在输出中包含类似以下格式的思维过程：

```
<think>
这个句子的结构比较复杂，我需要先理解其中的主谓关系...
这里的专业术语应该翻译为...
</think>
```

思维链过滤功能会自动检测并移除这些内容，只保留最终的翻译结果。

### 工作流程

1. **识别思维链**：程序使用正则表达式识别文本中的`<think>...</think>`标记。
2. **提取有效内容**：将思维链部分移除，只保留实际的翻译结果。
3. **结果优化**：确保过滤后的文本格式正确，没有多余的空行或标记。

### 优势

1. **纯净输出**：确保翻译结果不包含模型的思考过程，只有最终翻译。
2. **提高可读性**：避免用户看到与翻译无关的内容，提高文档的专业性。
3. **减少干扰**：特别是在批量翻译时，避免思维链内容干扰文档的整体结构。

## 实时日志同步功能

### 功能原理

实时日志同步功能确保Web界面的系统日志与终端控制台完全同步，为开发者和用户提供一致的日志体验。

### 技术实现

1. **统一日志格式器**：
   - 使用`UnifiedLogFormatter`类确保终端和Web界面使用相同的日志格式
   - 格式：`%(asctime)s - %(levelname)s - %(name)s - %(message)s`
   - 时间格式：`%Y-%m-%d %H:%M:%S`

2. **双重输出机制**：
   - 所有日志同时输出到终端控制台和Web界面
   - 终端输出：通过`sys.stdout`直接写入，确保实时显示
   - Web输出：通过WebSocket广播到所有连接的客户端

3. **智能缓存机制**：
   - 当没有Web客户端连接时，日志会被缓存在`pending_logs`队列中
   - 客户端连接后，会自动发送所有缓存的日志
   - 限制缓存大小（最大1000条），防止内存溢出

### 功能特点

1. **实时同步**：
   - 日志产生时立即同时显示在终端和Web界面
   - 无延迟，确保开发调试的实时性

2. **格式一致**：
   - 终端和Web界面显示完全相同的日志格式
   - 包含时间戳、日志级别、模块名称和消息内容

3. **智能过滤**：
   - 自动过滤不必要的框架日志（如uvicorn、fastapi）
   - 只显示与应用程序相关的重要日志

4. **连接状态管理**：
   - 支持多个Web客户端同时连接
   - 客户端断开重连时自动恢复日志同步

### 使用方法

1. **启动Web服务器**：
   ```bash
   python web_server.py
   ```

2. **观察终端日志**：
   - 所有系统日志会实时显示在终端控制台
   - 包括服务器启动、翻译任务处理、错误信息等

3. **查看Web界面日志**：
   - 打开浏览器访问Web界面
   - 在"系统日志"区域查看实时日志
   - 支持自动滚动、日志清空等功能

4. **测试日志同步**：
   ```bash
   python test_log_sync.py
   ```

### 调试和故障排除

1. **日志不同步**：
   - 检查WebSocket连接是否正常
   - 查看终端是否有WebSocket连接错误信息
   - 尝试刷新Web页面重新建立连接

2. **日志格式不一致**：
   - 确保使用了统一的日志格式器
   - 检查是否有其他模块修改了日志配置

3. **性能问题**：
   - 日志缓存队列有大小限制，不会无限增长
   - 可以通过清空Web界面日志来释放内存

## 系统要求

- Windows 10/11
- 至少4GB内存
- 至少500MB硬盘空间
- Microsoft Word（用于Word文档的PDF导出功能）
- Microsoft PowerPoint（用于PPT文档的PDF导出功能）
- 安装pdfplumber库（用于PDF文件处理）
- 安装python-pptx库（用于PPT文件处理）

## EXE一键部署

### 快速开始

本项目支持一键打包成EXE可执行文件，无需安装Python环境即可运行：

```bash
# 一键打包（推荐）
build.bat

# 手动打包
python build_exe.py

# 测试构建结果
python test_build.py
```

### 部署特性

- ✅ **一键启动**：双击EXE文件即可运行
- ✅ **完整环境**：包含所有依赖和虚拟环境
- ✅ **双模式支持**：GUI桌面版 + Web网页版
- ✅ **局域网访问**：Web版支持团队协作
- ✅ **自动浏览器**：Web版自动打开浏览器
- ✅ **智能端口**：自动检测并使用可用端口
- ✅ **错误处理**：完善的错误提示和日志

### 使用方法

1. **运行打包脚本**：
   ```bash
   # Windows系统
   build.bat
   ```

2. **获取EXE文件**：
   - 位置：`dist\文档术语翻译助手\`
   - 主程序：`文档术语翻译助手.exe`

3. **启动程序**：
   - 双击EXE文件
   - 选择启动模式（桌面版/Web版）
   - Web版会自动打开浏览器

4. **局域网访问**：
   - 启动Web版后获取局域网地址
   - 其他设备通过IP地址访问
   - 例如：`http://192.168.1.100:8000`

### 部署结构

```
文档术语翻译助手\
├── 文档术语翻译助手.exe    # 主程序
├── _internal\              # 内部依赖
├── API_config\             # API配置
├── data\                   # 数据文件
├── web\                    # Web界面
├── uploads\                # 上传目录
├── outputs\                # 输出目录
├── README.md               # 项目说明
├── 使用指南.md             # 使用指南
├── 使用说明.txt            # 快速说明
└── logo.ico                # 程序图标
```

### 技术细节

- **打包工具**：PyInstaller 6.11.1
- **打包模式**：单文件夹模式
- **压缩优化**：UPX压缩启用
- **依赖管理**：自动包含所有必需依赖
- **配置保留**：保留所有配置文件和数据

详细部署说明请参考：[部署指南.md](部署指南.md) 和 [打包说明.md](打包说明.md)
